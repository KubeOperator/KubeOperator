<clr-wizard #wizard [(clrWizardOpen)]="createClusterOpened" (clrWizardOnCancel)="onCancel()"
            (clrWizardOnFinish)="onSubmit()">
  <clr-wizard-title>创建集群</clr-wizard-title>

  <clr-wizard-button [type]="'cancel'">取消</clr-wizard-button>
  <clr-wizard-button [type]="'previous'">上一步</clr-wizard-button>
  <clr-wizard-button [type]="'next'">下一步</clr-wizard-button>
  <clr-wizard-button [type]="'finish'">完成</clr-wizard-button>
  <clr-wizard-page [clrWizardPageNextDisabled]="!basicFrom.valid">
    <form #basicFrom='ngForm' clrForm>
      <ng-template clrPageTitle>基本信息</ng-template>
      <div class="spinner" *ngIf="loadingFlag">
        Loading...
      </div>
      <clr-input-container>
        <label>集群名称:</label>
        <input clrInput type="text" [(ngModel)]="cluster.name" name="name" required>
      </clr-input-container>

      <clr-select-container>
        <label>离线包:</label>
        <select clrSelect name="package" [(ngModel)]="cluster.package" (change)="packgeOnChange()" required>
          <option [value]="">请选择</option>
          <option *ngFor="let package of packages" value="{{package.name}}">{{package.name}}</option>
        </select>
      </clr-select-container>
      <clr-textarea-container>
        <label>描述:</label>
        <textarea clrTextarea [(ngModel)]="cluster.comment" name="comment"></textarea>
      </clr-textarea-container>
    </form>

  </clr-wizard-page>

  <clr-wizard-page [clrWizardPageNextDisabled]="!templateForm.valid">
    <ng-template clrPageTitle>部署模型</ng-template>
    <form clrForm #templateForm='ngForm'>
      <clr-radio-wrapper *ngFor="let template of templates">
        <input required type="radio" clrRadio [(ngModel)]="cluster.template" [value]="template.name"
               name="template" (change)="templateOnChange()"/>
        <label>{{template.name}}</label>
      </clr-radio-wrapper>
      <div *ngIf="template">
        <div *ngFor="let role of template.roles">
          <div *ngIf="!role.meta.hidden">
            <h3>{{role.name}}</h3>
            <hr/>
            <div>
              节点数:
              {{role.meta.requires.nodes_require[0]}}
              {{role.meta.requires.nodes_require[1]}}
            </div>
            <div>
              支持操作系统:
              <span *ngFor="let os of role.meta.allow_os">
                {{os.name}}&nbsp;
                <span *ngFor="let version of os.version">
                  {{version}}&nbsp;
                </span>
              </span>
            </div>
            <h5>设备要求:</h5>
            <div>
              <clr-datagrid>
                <clr-dg-column>设备名称</clr-dg-column>
                <clr-dg-column>最低配置</clr-dg-column>
                <clr-dg-column>推荐配置</clr-dg-column>
                <clr-dg-column>单位</clr-dg-column>
                <clr-dg-column>备注</clr-dg-column>

                <clr-dg-row *clrDgItems="let require of role.meta.requires.device_require" [clrDgItem]="require">
                  <clr-dg-cell>{{require.verbose}}</clr-dg-cell>
                  <clr-dg-cell>{{require.minimal}}</clr-dg-cell>
                  <clr-dg-cell>{{require.excellent}}</clr-dg-cell>
                  <clr-dg-cell>{{require.unit}}</clr-dg-cell>
                  <clr-dg-cell>{{require.comment}}</clr-dg-cell>
                </clr-dg-row>
              </clr-datagrid>
            </div>
            <h5>磁盘要求:</h5>
            <div>
              <clr-datagrid>
                <clr-dg-column>设备名称</clr-dg-column>
                <clr-dg-column>最低配置</clr-dg-column>
                <clr-dg-column>推荐配置</clr-dg-column>
                <clr-dg-column>单位</clr-dg-column>
                <clr-dg-column>备注</clr-dg-column>

                <clr-dg-row *clrDgItems="let require of role.meta.requires.volumes_require" [clrDgItem]="require">
                  <clr-dg-cell>{{require.verbose}}</clr-dg-cell>
                  <clr-dg-cell>{{require.minimal}}</clr-dg-cell>
                  <clr-dg-cell>{{require.excellent}}</clr-dg-cell>
                  <clr-dg-cell>{{require.unit}}</clr-dg-cell>
                  <clr-dg-cell>{{require.comment}}</clr-dg-cell>
                </clr-dg-row>
              </clr-datagrid>
            </div>
          </div>
        </div>
      </div>

    </form>
  </clr-wizard-page>

  <!--<clr-wizard-page [clrWizardPageNextDisabled]="!nodeForm.valid" (clrWizardPageOnCommit)="fullNode()">-->
  <clr-wizard-page [clrWizardPageNextDisabled]="canNodeNext()" (clrWizardPageNext)="fullNode()">
    <ng-template clrPageTitle>配置节点</ng-template>
    <form #nodeForm='ngForm' clrForm>
      <div *ngFor="let group of groups">
        <h4>{{group.name}}</h4>
        <hr/>
        <div *ngFor="let node of group.nodes" class="clr-row">
          <div class="clr-col-10">
            <h3>{{node.name}}</h3>
            <clr-select-container>
              <label>选择主机:</label>
              <select clrSelect [(ngModel)]="node.host" [ngModelOptions]="{standalone: true}"
                      (change)="onHostChange(node)">
                <option [value]="">请选择</option>
                <option *ngFor="let host of hosts | hostsFilter :nodes:node "
                        value="{{host.id}}">{{host.name}}</option>
              </select>
            </clr-select-container>
            <div *ngIf="group.node_vars">
              <span>选择磁盘:</span>
              <div *ngFor="let _var of group.node_vars">
                <clr-select-container>
                  <label>{{_var.name}}:</label>
                  <select clrSelect [(ngModel)]="node.vars[_var.name]" [ngModelOptions]="{standalone: true}">
                    <option value="">请选择磁盘</option>
                    <option *ngFor="let v of node.volumes" [value]="replaceVolumeName(v,_var.template)">{{v}}</option>
                  </select>
                </clr-select-container>
              </div>
            </div>
          </div>
          <div *ngIf="node.delete" class="clr-col-2">
            <button class="btn btn-info-outline" (click)="deleteNode(group,node)">
              <clr-icon shape="times"></clr-icon>
            </button>
          </div>
        </div>
        <div *ngIf="group.op!== '='">
          <button class="btn btn-info-outline" (click)="addNode(group)">
            <clr-icon shape="plus"></clr-icon>
          </button>
        </div>
      </div>
    </form>
  </clr-wizard-page>

  <!--<clr-wizard-page [clrWizardPageNextDisabled]="!canCheckNext()">-->
  <clr-wizard-page>
    <ng-template clrPageTitle>配置检查</ng-template>
    <div>
      1.检查cpu
      <span [ngSwitch]="checkCpuState">
      <i *ngSwitchCase="'pending'" class=" fa fa-spinner fa-spin"></i>
      <clr-icon *ngSwitchCase="'success'" shape="success-standard"></clr-icon>
      <clr-icon *ngSwitchCase="'fail'" shape="error-standar" class="is-solid"></clr-icon>
      </span><br/>
      <div *ngIf="checkCpuState === 'fail'">
        <span style="color: green;">通过检查:</span> {{checkCpuResult.passed}}
        <br/>
        <span style="color: red;">未通过检查:</span> {{checkCpuResult.failed}}
      </div>
    </div>
    <div>
      2.检查内存
      <span [ngSwitch]="checkMemoryState">
         <i *ngSwitchCase="'pending'" class=" fa fa-spinner fa-spin"></i>
      <clr-icon *ngSwitchCase="'success'" shape="success-standard"></clr-icon>
      <clr-icon *ngSwitchCase="'fail'" shape="error-standar" class="is-solid"></clr-icon>
      </span><br/>
      <div *ngIf="checkMemoryState === 'fail'">
        <span style="color: green;">通过检查:</span> {{checkMemoryResult.passed}}
        <br/>
        <span style="color: red;">未通过检查:</span> {{checkMemoryResult.failed}}
      </div>
    </div>
    <div>
      3.检查操作系统
      <span [ngSwitch]="checkOsState">
      <i *ngSwitchCase="'pending'" class=" fa fa-spinner fa-spin"></i>
      <clr-icon *ngSwitchCase="'success'" shape="success-standard"></clr-icon>
      <clr-icon *ngSwitchCase="'fail'" shape="error-standar" class="is-solid"></clr-icon>
      </span><br/>
      <div *ngIf="checkOsState === 'fail'">
        <span style="color: green;">通过检查:</span> {{checkOsResult.passed}}
        <br/>
        <span style="color: red;">未通过检查:</span> {{checkOsResult.failed}}
      </div>
    </div>
  </clr-wizard-page>


  <clr-wizard-page [clrWizardPageNextDisabled]="canConfigNext()">
    <ng-template clrPageTitle>设置参数</ng-template>
    <form #configForm='ngForm' clrForm>
      <div *ngFor="let config of configs">
        <div [ngSwitch]="config.type">
          <clr-input-container *ngSwitchCase="'Input'">
            <label>{{config.alias}}</label>
            <label>
              <input clrInput type="text" [value]="config.default" [(ngModel)]="config.value"
                     [ngModelOptions]="{standalone: true}" [required]="config.require">
            </label>
          </clr-input-container>

          <clr-checkbox [clrInline]="true" *ngSwitchCase="'Checkbox'" [(ngModel)]="config.value"
                        [ngModelOptions]="{standalone: true}">
            {{config.alias}}
          </clr-checkbox>
        </div>
      </div>
    </form>

  </clr-wizard-page>

  <clr-wizard-page>
    <ng-template clrPageTitle>完成</ng-template>
    <section class="form-block">
      <div class="form-group">
        <label>集群名称:</label>
        <span>{{cluster.name}}</span>
      </div>

      <div class="form-group">
        <label>部署模型:</label>
        <span>{{cluster.template}}</span>
      </div>

      <div class="form-group" *ngFor="let config of configs">
        <label>{{config.alias}}:</label>
        <span>{{config.value}}</span>
      </div>
      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <h5>节点信息</h5>
          <table class="table">
            <thead>
            <tr>
              <th>节点名称</th>
              <th>IP</th>
              <th>CPU(核)</th>
              <th>内存</th>
              <th>操作系统</th>
              <th>角色</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let node of nodes">
              <td>{{node.name}}</td>
              <td>{{node.ip}}</td>
              <td>{{node.host_cpu_core}}</td>
              <td>{{node.host_memory}}</td>
              <td>{{node.host_os}} {{node.host_os_version}}</td>
              <td>{{node.roles}}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </clr-wizard-page>
</clr-wizard>
